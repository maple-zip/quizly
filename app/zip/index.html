<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quizly</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                            950: '#172554'
                        },
                        success: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            500: '#22c55e',
                            600: '#16a34a'
                        },
                        danger: {
                            50: '#fef2f2',
                            100: '#fee2e2',
                            500: '#ef4444',
                            600: '#dc2626'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        @keyframes pulse-warning {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(0); opacity: 1; }
            to { transform: translateY(-100%); opacity: 0; }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
        .timer-warning {
            animation: pulse-warning 1s infinite;
        }
        /* Hide scrollbar for mobile topbar */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* Custom radio/checkbox styles */
        .choice-item:has(input:checked) {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        .tf-btn:has(input:checked) {
            border-color: #3b82f6;
            background: #eff6ff;
            color: #1d4ed8;
        }
        /* Smooth scroll */
        html {
            scroll-behavior: smooth;
        }
        /* Progress bar animation */
        .progress-bar {
            transition: width 0.3s ease;
        }
        /* Mobile expand panel animations */
        .expand-panel-enter {
            animation: slideDown 0.3s ease-out forwards;
        }
        .expand-panel-leave {
            animation: slideUp 0.3s ease-out forwards;
        }
        .expand-overlay-enter {
            animation: fadeIn 0.3s ease-out forwards;
        }
        .expand-overlay-leave {
            animation: fadeOut 0.3s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-primary-600 to-primary-900 min-h-screen font-sans text-primary-950">

    <!-- Custom Modal Dialog -->
    <div id="modalOverlay" class="fixed inset-0 bg-black/60 z-[9999] hidden items-center justify-center p-4">
        <div id="modalContent" class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 transform scale-95 opacity-0 transition-all duration-200">
            <p id="modalMessage" class="text-lg text-primary-900 mb-6 text-center"></p>
            <div id="modalButtons" class="flex gap-3 justify-center">
                <!-- Buttons will be inserted dynamically -->
            </div>
        </div>
    </div>

    <!-- Resume Session Dialog -->
    <div id="resumeDialog" class="fixed inset-0 bg-black/60 z-[9998] hidden items-center justify-center p-4">
        <div id="resumeDialogContent" class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 transform scale-95 opacity-0 transition-all duration-200">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <h3 class="text-xl font-bold text-primary-900 mb-2">Phát hiện bài làm chưa hoàn thành</h3>
                <p class="text-primary-600">Bạn có muốn tiếp tục làm bài từ lần trước không?</p>
            </div>
            <div class="flex gap-3 justify-center">
                <button id="resumeNewBtn" class="px-6 py-2.5 bg-primary-100 text-primary-700 rounded-lg font-semibold hover:bg-primary-200 transition-colors">
                    Làm lại từ đầu
                </button>
                <button id="resumeContinueBtn" class="px-6 py-2.5 bg-primary-600 text-white rounded-lg font-semibold hover:bg-primary-700 transition-colors">
                    Tiếp tục làm bài
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Screen with Progress -->
    <div id="loadingScreen" class="flex flex-col items-center justify-center min-h-screen text-white px-4">
        <div class="w-12 h-12 border-4 border-white/30 border-t-white rounded-full spinner mb-4"></div>
        <p id="loadingText" class="text-lg mb-4">Đang tải bài ôn tập...</p>
        <!-- Progress Bar -->
        <div id="progressContainer" class="w-full max-w-xs hidden">
            <div class="bg-white/20 rounded-full h-3 overflow-hidden">
                <div id="progressBar" class="progress-bar bg-white h-full rounded-full" style="width: 0%"></div>
            </div>
            <p id="progressText" class="text-sm text-white/80 mt-2 text-center">0%</p>
        </div>
    </div>

    <!-- 404 Error Screen -->
    <div id="errorScreen" class="hidden items-center justify-center min-h-screen p-4">
        <div class="bg-white p-10 sm:p-14 rounded-2xl text-center max-w-md shadow-2xl">
            <h1 class="text-7xl text-danger-500 mb-4">404</h1>
            <h2 class="text-2xl font-bold text-primary-900 mb-4">Không tìm thấy bài ôn tập</h2>
            <p class="text-primary-700 mb-6">URL ZIP không hợp lệ hoặc không thể truy cập.</p>
            <a href="https://maple-zip.github.io/quizly" class="inline-block bg-primary-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-primary-700 transition-colors">
                ← Quay về dự án Quizly
            </a>
        </div>
    </div>

    <!-- Time Expired Screen -->
    <div id="timeExpiredScreen" class="hidden items-center justify-center min-h-screen p-4">
        <div class="bg-white p-10 sm:p-14 rounded-2xl text-center max-w-md shadow-2xl">
            <h1 class="text-6xl mb-4">⏰</h1>
            <h2 class="text-2xl font-bold text-primary-900 mb-4">Hết thời gian làm bài</h2>
            <p class="text-primary-700 mb-2">Bài ôn tập này đã đóng.</p>
            <p id="timeExpiredInfo" class="text-primary-600 mb-6"></p>
            <a href="https://maple-zip.github.io/quizly" class="inline-block bg-primary-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-primary-700 transition-colors">
                ← Quay về dự án Quizly
            </a>
        </div>
    </div>

    <!-- Exam Info Screen -->
    <div id="examInfoScreen" class="hidden items-center justify-center min-h-screen p-4">
        <a href="https://maple-zip.github.io/quizly" class="fixed top-4 left-4 z-50" target="_blank">
            <div class="bg-white/95 px-4 py-2 rounded-lg shadow-lg">
                <span class="text-xl font-bold text-primary-600">Quizly</span>
            </div>
        </a>
        <div class="bg-white p-8 sm:p-12 rounded-2xl max-w-2xl w-full shadow-2xl">
            <h1 id="examTitle" class="text-2xl sm:text-3xl font-bold text-primary-900 mb-8 text-center"></h1>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
                <div class="flex flex-col gap-1">
                    <span class="text-xs font-semibold text-primary-500 uppercase tracking-wide">Môn học</span>
                    <span id="examSubject" class="text-lg text-primary-900"></span>
                </div>
                <div class="flex flex-col gap-1">
                    <span class="text-xs font-semibold text-primary-500 uppercase tracking-wide">Khối</span>
                    <span id="examGrade" class="text-lg text-primary-900"></span>
                </div>
                <div class="flex flex-col gap-1">
                    <span class="text-xs font-semibold text-primary-500 uppercase tracking-wide">Tác giả</span>
                    <span id="examAuthor" class="text-lg text-primary-900"></span>
                </div>
                <div class="flex flex-col gap-1">
                    <span class="text-xs font-semibold text-primary-500 uppercase tracking-wide">Tổng số câu</span>
                    <span id="examQuestionCount" class="text-lg text-primary-900"></span>
                </div>
                <div class="flex flex-col gap-1 sm:col-span-2">
                    <span class="text-xs font-semibold text-primary-500 uppercase tracking-wide">Thời gian làm bài</span>
                    <span id="examDuration" class="text-lg text-primary-900"></span>
                </div>
            </div>
            <div id="examDescription" class="bg-primary-50 p-4 rounded-lg text-primary-800 mb-8 leading-relaxed"></div>
            <button id="startExamBtn" class="w-full bg-primary-600 text-white py-4 rounded-xl font-bold text-lg hover:bg-primary-700 transition-all hover:shadow-lg active:scale-[0.98]">
                Bắt đầu làm bài
            </button>
        </div>
    </div>

    <!-- Exam Screen -->
    <div id="examScreen" class="hidden min-h-screen">
        
        <!-- Mobile Top Bar -->
        <div id="mobileTopBar" class="lg:hidden fixed top-0 left-0 right-0 bg-white shadow-lg z-50">
            <!-- Row 1: Question Navigation with Expand Button -->
            <div class="flex items-center gap-2 px-3 py-2 border-b border-primary-100">
                <!-- Expand Button -->
                <button id="mobileExpandBtn" class="flex-shrink-0 w-9 h-9 flex items-center justify-center rounded-lg bg-primary-100 text-primary-600 hover:bg-primary-200 transition-all">
                    <svg id="expandIcon" class="w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
                <!-- Question cells container -->
                <div id="mobileQuestionNav" class="flex-1 flex items-center gap-2 overflow-x-auto hide-scrollbar">
                    <!-- Question cells will be inserted here -->
                </div>
            </div>
            <!-- Row 2: Title, Timer, Submit -->
            <div class="flex items-center justify-between px-3 py-2 gap-2">
                <h3 id="mobileExamTitle" class="text-sm font-semibold text-primary-900 truncate flex-1 min-w-0"></h3>
                <div id="mobileTimer" class="font-mono font-bold text-primary-700 text-sm whitespace-nowrap px-2 py-1 bg-primary-50 rounded">00:00:00</div>
                <button id="mobileSubmitBtn" class="bg-primary-600 text-white px-3 py-1.5 rounded-lg text-sm font-semibold hover:bg-primary-700 transition-colors whitespace-nowrap">
                    Nộp bài
                </button>
            </div>
        </div>

        <!-- Mobile Expand Panel Overlay -->
        <div id="mobileExpandOverlay" class="lg:hidden fixed inset-0 bg-black/50 z-[60] hidden">
            <!-- Panel Content (max 2/3 screen from top) -->
            <div id="mobileExpandPanel" class="bg-white shadow-2xl max-h-[66vh] overflow-y-auto">
                <div class="p-4">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-lg font-bold text-primary-900">Danh sách câu hỏi</h4>
                        <button id="mobileExpandClose" class="w-8 h-8 flex items-center justify-center rounded-lg bg-primary-100 text-primary-600 hover:bg-primary-200 transition-all">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div id="mobileExpandGrid" class="grid grid-cols-6 gap-2">
                        <!-- Question cells will be inserted here -->
                    </div>
                </div>
            </div>
            <!-- Click outside to close -->
            <div id="mobileExpandBackdrop" class="flex-1"></div>
        </div>

        <!-- Desktop Layout -->
        <div class="flex">
            <!-- Desktop Sidebar -->
            <div id="sidebar" class="hidden lg:flex w-72 bg-white shadow-xl flex-col sticky top-0 h-screen">
                <!-- Header: Logo + Title -->
                <div class="p-5 border-b border-primary-100">
                    <a href="https://maple-zip.github.io/quizly" class="block mb-3" target="_blank">
                        <span class="text-xl font-bold text-primary-600">Quizly</span>
                    </a>
                    <h3 id="sidebarExamTitle" class="text-base font-semibold text-primary-900 line-clamp-2"></h3>
                </div>
                
                <!-- Timer: Fixed outside scroll area -->
                <div class="p-5 border-b border-primary-100">
                    <div class="bg-primary-50 p-4 rounded-xl text-center">
                        <div class="text-xs font-semibold text-primary-500 uppercase mb-2">Thời gian</div>
                        <div id="desktopTimer" class="text-2xl font-bold font-mono text-primary-900">00:00:00</div>
                    </div>
                </div>
                
                <!-- Question Grid: Scrollable area with auto-scroll -->
                <div id="desktopQuestionGridContainer" class="flex-1 overflow-y-auto p-5 hide-scrollbar">
                    <div id="desktopQuestionGrid" class="grid grid-cols-5 gap-2">
                        <!-- Question cells -->
                    </div>
                </div>
                
                <!-- Submit Button: Fixed at bottom -->
                <div class="p-5 border-t border-primary-100">
                    <button id="desktopSubmitBtn" class="w-full bg-primary-600 text-white py-3 rounded-xl font-semibold hover:bg-primary-700 transition-all hover:shadow-lg active:scale-[0.98]">
                        Nộp bài
                    </button>
                </div>
            </div>

            <!-- Main Content -->
            <div class="flex-1 p-4 lg:p-8 pt-28 lg:pt-8">
                <div id="questionContainer" class="max-w-3xl mx-auto space-y-6">
                    <!-- Questions will be rendered here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Results Screen -->
    <div id="resultsScreen" class="hidden min-h-screen">
        <!-- Mobile Results Top Bar -->
        <div id="mobileResultsTopBar" class="lg:hidden fixed top-0 left-0 right-0 bg-white shadow-lg z-50">
            <div class="flex items-center gap-2 px-3 py-2 border-b border-primary-100">
                <!-- Expand Button -->
                <button id="mobileResultsExpandBtn" class="flex-shrink-0 w-9 h-9 flex items-center justify-center rounded-lg bg-primary-100 text-primary-600 hover:bg-primary-200 transition-all">
                    <svg class="w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
                <!-- Wrong answers only or message -->
                <div id="mobileResultsNav" class="flex-1 flex items-center gap-2 overflow-x-auto hide-scrollbar">
                    <!-- Wrong question cells or message will be inserted here -->
                </div>
            </div>
            <div class="px-3 py-2">
                <h3 id="mobileResultsTitle" class="text-sm font-semibold text-primary-900">Kết quả ôn tập</h3>
            </div>
        </div>

        <!-- Mobile Results Expand Panel Overlay -->
        <div id="mobileResultsExpandOverlay" class="lg:hidden fixed inset-0 bg-black/50 z-[60] hidden">
            <div id="mobileResultsExpandPanel" class="bg-white shadow-2xl max-h-[66vh] overflow-y-auto">
                <div class="p-4">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-lg font-bold text-primary-900">Tổng kết đáp án</h4>
                        <button id="mobileResultsExpandClose" class="w-8 h-8 flex items-center justify-center rounded-lg bg-primary-100 text-primary-600 hover:bg-primary-200 transition-all">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div id="mobileResultsExpandGrid" class="flex flex-wrap gap-2">
                        <!-- Question cells with correct/wrong colors -->
                    </div>
                </div>
            </div>
            <div id="mobileResultsExpandBackdrop" class="flex-1"></div>
        </div>

        <!-- Desktop Results Layout -->
        <div class="flex">
            <!-- Desktop Results Sidebar -->
            <div id="resultsSidebar" class="hidden lg:flex w-72 bg-white shadow-xl flex-col sticky top-0 h-screen">
                <div class="p-5 border-b border-primary-100">
                    <a href="https://maple-zip.github.io/quizly" class="block mb-3" target="_blank">
                        <span class="text-xl font-bold text-primary-600">Quizly</span>
                    </a>
                    <h3 id="sidebarResultsTitle" class="text-base font-semibold text-primary-900 line-clamp-2">Kết quả ôn tập</h3>
                </div>
                
                <div id="resultsQuestionGridContainer" class="flex-1 overflow-y-auto p-5 hide-scrollbar">
                    <div id="resultsQuestionGrid" class="grid grid-cols-5 gap-2">
                        <!-- Question cells with correct/wrong colors -->
                    </div>
                </div>
                
                <div class="p-5 border-t border-primary-100">
                    <button id="sidebarReviewBtn" class="w-full bg-primary-600 text-white py-3 rounded-xl font-semibold hover:bg-primary-700 transition-all hover:shadow-lg active:scale-[0.98]">
                        Làm lại
                    </button>
                </div>
            </div>

            <!-- Results Main Content -->
            <div class="flex-1 p-4 lg:p-8 pt-24 lg:pt-8">
                <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-2xl p-6 sm:p-10">
                    <h1 class="text-2xl sm:text-3xl font-bold text-primary-900 text-center mb-8">Kết quả ôn tập</h1>
                    
                    <div id="scoreSummary" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
                        <!-- Score cards -->
                    </div>

                    <div class="mb-8">
                        <h2 class="text-xl sm:text-2xl font-bold text-primary-900 mb-6">Chi tiết kết quả</h2>
                        <div id="resultsDetailsContainer" class="space-y-4">
                            <!-- Results -->
                        </div>
                    </div>

                    <button id="reviewBtn" class="w-full sm:w-auto bg-primary-600 text-white px-8 py-3 rounded-xl font-semibold hover:bg-primary-700 transition-all">
                        Làm lại
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let configData = null;
        let questionsData = null;
        let questions = [];
        let userAnswers = {};
        let startTime = null;
        let timerInterval = null;
        let mediaFiles = {};
        let currentPlayingMedia = null;
        let currentQuestionIndex = 0;
        let isForceSubmit = false;
        let isMobileExpandOpen = false;
        let isMobileResultsExpandOpen = false;
        let questionResults = []; // Track correct/wrong for each question
        let actualDuration = 0; // Track actual time spent

        // Get ZIP URL from query string
        const urlParams = new URLSearchParams(window.location.search);
        const zipUrl = urlParams.get('zip');

        // LocalStorage key for this quiz
        function getStorageKey() {
            return 'quizly_progress_' + btoa(zipUrl || '').slice(0, 32);
        }

        // Save progress to localStorage
        function saveProgress() {
            if (!zipUrl) return;
            const data = {
                zipUrl: zipUrl,
                userAnswers: userAnswers,
                startTime: startTime,
                currentQuestionIndex: currentQuestionIndex,
                savedAt: Date.now()
            };
            localStorage.setItem(getStorageKey(), JSON.stringify(data));
        }

        // Load progress from localStorage
        function loadProgress() {
            const key = getStorageKey();
            const saved = localStorage.getItem(key);
            if (!saved) return null;
            try {
                return JSON.parse(saved);
            } catch (e) {
                return null;
            }
        }

        // Clear progress from localStorage
        function clearProgress() {
            localStorage.removeItem(getStorageKey());
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            if (!zipUrl) {
                showError();
                return;
            }

            try {
                await loadZip(zipUrl);
                const ok = validateExamTime();
                if (!ok) return;
                showExamInfo();
            } catch (error) {
                console.error('Error loading exam:', error);
                showError();
            }
        });

        // ============ CUSTOM MODAL DIALOG ============
        function showModal(message, buttons) {
            return new Promise((resolve) => {
                const overlay = document.getElementById('modalOverlay');
                const content = document.getElementById('modalContent');
                const msgEl = document.getElementById('modalMessage');
                const btnContainer = document.getElementById('modalButtons');

                msgEl.textContent = message;
                btnContainer.innerHTML = '';

                buttons.forEach((btn, index) => {
                    const button = document.createElement('button');
                    button.textContent = btn.text;
                    button.className = btn.primary 
                        ? 'px-6 py-2.5 bg-primary-600 text-white rounded-lg font-semibold hover:bg-primary-700 transition-colors'
                        : 'px-6 py-2.5 bg-primary-100 text-primary-700 rounded-lg font-semibold hover:bg-primary-200 transition-colors';
                    button.onclick = () => {
                        closeModal();
                        resolve(btn.value);
                    };
                    btnContainer.appendChild(button);
                });

                overlay.classList.remove('hidden');
                overlay.classList.add('flex');
                
                requestAnimationFrame(() => {
                    content.classList.remove('scale-95', 'opacity-0');
                    content.classList.add('scale-100', 'opacity-100');
                });
            });
        }

        function closeModal() {
            const overlay = document.getElementById('modalOverlay');
            const content = document.getElementById('modalContent');
            
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                overlay.classList.remove('flex');
                overlay.classList.add('hidden');
            }, 200);
        }

        async function confirmDialog(message) {
            return await showModal(message, [
                { text: 'Hủy', value: false, primary: false },
                { text: 'Xác nhận', value: true, primary: true }
            ]);
        }

        async function alertDialog(message) {
            return await showModal(message, [
                { text: 'OK', value: true, primary: true }
            ]);
        }

        // ============ RESUME DIALOG ============
        function showResumeDialog() {
            return new Promise((resolve) => {
                const overlay = document.getElementById('resumeDialog');
                const content = document.getElementById('resumeDialogContent');

                overlay.classList.remove('hidden');
                overlay.classList.add('flex');
                
                requestAnimationFrame(() => {
                    content.classList.remove('scale-95', 'opacity-0');
                    content.classList.add('scale-100', 'opacity-100');
                });

                document.getElementById('resumeNewBtn').onclick = () => {
                    closeResumeDialog();
                    resolve(false);
                };

                document.getElementById('resumeContinueBtn').onclick = () => {
                    closeResumeDialog();
                    resolve(true);
                };
            });
        }

        function closeResumeDialog() {
            const overlay = document.getElementById('resumeDialog');
            const content = document.getElementById('resumeDialogContent');
            
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                overlay.classList.remove('flex');
                overlay.classList.add('hidden');
            }, 200);
        }

        // ============ LOADING WITH PROGRESS ============
        function updateProgress(percent, text) {
            const container = document.getElementById('progressContainer');
            const bar = document.getElementById('progressBar');
            const textEl = document.getElementById('progressText');
            const loadingText = document.getElementById('loadingText');

            container.classList.remove('hidden');
            bar.style.width = `${percent}%`;
            textEl.textContent = `${Math.round(percent)}%`;
            if (text) loadingText.textContent = text;
        }

        // Load and parse ZIP with progress
        async function loadZip(url) {
            updateProgress(0, 'Đang tải file ôn tập...');
            
            const response = await fetch(url);
            if (!response.ok) throw new Error('Failed to fetch ZIP');
            
            const contentLength = response.headers.get('content-length');
            const total = parseInt(contentLength, 10) || 0;
            
            let loaded = 0;
            const reader = response.body.getReader();
            const chunks = [];
            
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                chunks.push(value);
                loaded += value.length;
                if (total > 0) {
                    updateProgress((loaded / total) * 50, 'Đang tải file ôn tập...');
                }
            }
            
            const arrayBuffer = new Uint8Array(loaded);
            let position = 0;
            for (const chunk of chunks) {
                arrayBuffer.set(chunk, position);
                position += chunk.length;
            }
            
            updateProgress(50, 'Đang giải nén...');
            const zip = await JSZip.loadAsync(arrayBuffer);
            
            updateProgress(60, 'Đang đọc cấu hình...');
            
            // Read config.yaml
            const configFile = zip.file('config.yaml');
            if (!configFile) throw new Error('config.yaml not found');
            const configText = await configFile.async('text');
            configData = jsyaml.load(configText);

            updateProgress(70, 'Đang đọc câu hỏi...');
            
            // Read questions.yaml
            const questionsFile = zip.file('questions.yaml');
            if (!questionsFile) throw new Error('questions.yaml not found');
            const questionsText = await questionsFile.async('text');
            questionsData = jsyaml.load(questionsText);

            updateProgress(80, 'Đang tải media...');
            
            // Load media files
            const mediaFolder = zip.folder('media');
            if (mediaFolder) {
                const mediaPromises = [];
                const mediaEntries = [];
                mediaFolder.forEach((relativePath, file) => {
                    if (!file.dir) {
                        mediaEntries.push({ relativePath, file });
                    }
                });
                
                let mediaLoaded = 0;
                for (const { relativePath, file } of mediaEntries) {
                    const blob = await file.async('blob');
                    const blobUrl = URL.createObjectURL(blob);
                    mediaFiles[relativePath] = blobUrl;
                    mediaLoaded++;
                    updateProgress(80 + (mediaLoaded / mediaEntries.length) * 15, 'Đang tải media...');
                }
            }

            updateProgress(95, 'Đang xử lý câu hỏi...');
            
            // Build questions with original index
            const rawQuestions = (questionsData.questions || []).map((q, index) => ({
                ...q,
                originalIndex: index,
                id: `q${index}`
            }));

            // Filter out essay questions
            const filtered = rawQuestions.filter(q => q.type !== 'essay');

            // Ensure grouping: multiple_choice (ABCD), true_false_group
            const mc = filtered.filter(q => q.type === 'multiple_choice');
            const tf = filtered.filter(q => q.type === 'true_false_group');

            // Shuffle within groups if configured
            if (configData.exam && configData.exam.shuffle_questions) {
                shuffleArray(mc);
                shuffleArray(tf);
            }

            // Assign final questions array as grouped (MC -> TF)
            questions = [...mc, ...tf];

            // Shuffle answers for multiple choice and shuffle items for TF if configured
            if (configData.exam && configData.exam.shuffle_answers) {
                questions.forEach(q => {
                    if (q.type === 'multiple_choice') {
                        shuffleChoices(q);
                    } else if (q.type === 'true_false_group') {
                        shuffleItems(q);
                    }
                });
            } else {
                questions.forEach(q => {
                    if (q.type === 'multiple_choice' && !q.shuffledChoices) {
                        shuffleChoicesKeepOrder(q);
                    } else if (q.type === 'true_false_group' && !q.shuffledItems) {
                        shuffleItemsKeepOrder(q);
                    }
                });
            }
            
            updateProgress(100, 'Hoàn tất!');
        }

        // Validate exam time
        function validateExamTime() {
            const now = new Date();
            const start = new Date(configData.exam.start_time);
            const end = new Date(configData.exam.end_time);

            if (now < start) {
                showTimeExpired(`Bài ôn tập sẽ mở vào ${start.toLocaleString('vi-VN')}`);
                return false;
            }

            if (now > end) {
                showTimeExpired(`Bài ôn tập đã đóng vào ${end.toLocaleString('vi-VN')}`);
                return false;
            }

            return true;
        }

        // Show exam info
        function showExamInfo() {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('examInfoScreen').classList.remove('hidden');
            document.getElementById('examInfoScreen').classList.add('flex');

            document.getElementById('examTitle').textContent = configData.metadata.title;
            document.getElementById('examSubject').textContent = configData.metadata.subject;
            document.getElementById('examGrade').textContent = `Lớp ${configData.metadata.grade}`;
            document.getElementById('examAuthor').textContent = configData.metadata.author;
            document.getElementById('examQuestionCount').textContent = `${questions.length} câu`;
            
            const duration = configData.exam.duration_minutes || 0;
            document.getElementById('examDuration').textContent = duration > 0 
                ? `${duration} phút` 
                : 'Không giới hạn';

            document.getElementById('examDescription').textContent = configData.exam.description;

            document.getElementById('startExamBtn').addEventListener('click', checkAndStartExam);
        }

        // Check for saved progress and start exam
        async function checkAndStartExam() {
            const saved = loadProgress();
            
            if (saved && saved.userAnswers && Object.keys(saved.userAnswers).length > 0) {
                const shouldResume = await showResumeDialog();
                if (shouldResume) {
                    startExam(saved);
                } else {
                    clearProgress();
                    startExam(null);
                }
            } else {
                startExam(null);
            }
        }

        // Start exam
        function startExam(savedData) {
            document.getElementById('examInfoScreen').classList.add('hidden');
            document.getElementById('examInfoScreen').classList.remove('flex');
            document.getElementById('examScreen').classList.remove('hidden');

            // Set exam title
            const title = configData.metadata.title;
            document.getElementById('mobileExamTitle').textContent = title;
            document.getElementById('sidebarExamTitle').textContent = title;
            
            // Update document title
            document.title = title;

            // Restore saved data or start fresh
            if (savedData) {
                userAnswers = savedData.userAnswers || {};
                startTime = savedData.startTime || Date.now();
                currentQuestionIndex = savedData.currentQuestionIndex || 0;
            } else {
                startTime = Date.now();
                userAnswers = {};
                currentQuestionIndex = 0;
            }

            initTimer();
            renderMobileQuestionNav();
            renderDesktopQuestionGrid();
            renderMobileExpandGrid();
            renderQuestions();

            // Setup mobile expand functionality
            setupMobileExpand();

            document.getElementById('mobileSubmitBtn').addEventListener('click', () => submitExam(false));
            document.getElementById('desktopSubmitBtn').addEventListener('click', () => submitExam(false));

            // Scroll to saved question if resuming
            if (savedData && savedData.currentQuestionIndex > 0) {
                setTimeout(() => scrollToQuestion(savedData.currentQuestionIndex), 500);
            }

            // Save initial progress
            saveProgress();
        }

        // Setup mobile expand panel
        function setupMobileExpand() {
            const expandBtn = document.getElementById('mobileExpandBtn');
            const overlay = document.getElementById('mobileExpandOverlay');
            const closeBtn = document.getElementById('mobileExpandClose');
            const backdrop = document.getElementById('mobileExpandBackdrop');
            const panel = document.getElementById('mobileExpandPanel');

            expandBtn.addEventListener('click', toggleMobileExpand);
            closeBtn.addEventListener('click', closeMobileExpand);
            backdrop.addEventListener('click', closeMobileExpand);
        }

        function toggleMobileExpand() {
            if (isMobileExpandOpen) {
                closeMobileExpand();
            } else {
                openMobileExpand();
            }
        }

        function openMobileExpand() {
            const overlay = document.getElementById('mobileExpandOverlay');
            const panel = document.getElementById('mobileExpandPanel');
            
            isMobileExpandOpen = true;
            overlay.classList.remove('hidden');
            overlay.classList.add('flex', 'flex-col');
            panel.classList.add('expand-panel-enter');
            overlay.classList.add('expand-overlay-enter');
            
            // Update grid with current state
            updateMobileExpandGrid();
        }

        function closeMobileExpand() {
            const overlay = document.getElementById('mobileExpandOverlay');
            const panel = document.getElementById('mobileExpandPanel');
            
            isMobileExpandOpen = false;
            panel.classList.remove('expand-panel-enter');
            panel.classList.add('expand-panel-leave');
            overlay.classList.remove('expand-overlay-enter');
            overlay.classList.add('expand-overlay-leave');
            
            setTimeout(() => {
                overlay.classList.add('hidden');
                overlay.classList.remove('flex', 'flex-col', 'expand-overlay-leave');
                panel.classList.remove('expand-panel-leave');
            }, 300);
        }

        // Render mobile expand grid
        function renderMobileExpandGrid() {
            const grid = document.getElementById('mobileExpandGrid');
            grid.innerHTML = '';

            questions.forEach((q, index) => {
                const cell = document.createElement('button');
                cell.className = 'aspect-square flex items-center justify-center rounded-lg text-sm font-semibold transition-all bg-primary-50 text-primary-700 hover:bg-primary-100';
                cell.textContent = index + 1;
                cell.dataset.index = index;
                cell.id = `expand-cell-${index}`;
                cell.addEventListener('click', () => {
                    scrollToQuestion(index);
                    closeMobileExpand();
                });
                grid.appendChild(cell);
            });
        }

        // Update mobile expand grid state
        function updateMobileExpandGrid() {
            questions.forEach((q, index) => {
                const cell = document.getElementById(`expand-cell-${index}`);
                if (!cell) return;
                
                const answered = isQuestionAnswered(index);
                cell.classList.remove('bg-primary-50', 'bg-success-100', 'text-success-600', 'ring-2', 'ring-primary-400');
                
                if (index === currentQuestionIndex) {
                    if (answered) {
                        cell.classList.add('bg-success-100', 'text-success-600', 'ring-2', 'ring-primary-400');
                    } else {
                        cell.classList.add('bg-primary-100', 'ring-2', 'ring-primary-400');
                    }
                } else {
                    if (answered) {
                        cell.classList.add('bg-success-100', 'text-success-600');
                    } else {
                        cell.classList.add('bg-primary-50');
                    }
                }
            });
        }

        // Initialize timer
        function initTimer() {
            const duration = configData.exam.duration_minutes || 0;
            const isCountdown = duration > 0;

            const updateDisplay = () => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                
                if (isCountdown) {
                    const remaining = duration * 60 - elapsed;
                    if (remaining <= 0) {
                        clearInterval(timerInterval);
                        forceSubmit();
                        return;
                    }
                    const timeText = formatTime(remaining);
                    document.getElementById('mobileTimer').textContent = timeText;
                    document.getElementById('desktopTimer').textContent = timeText;
                    
                    // Warning when 1 minute left
                    if (remaining <= 60) {
                        document.getElementById('mobileTimer').classList.add('timer-warning', 'text-danger-600', 'bg-danger-50');
                        document.getElementById('mobileTimer').classList.remove('text-primary-700', 'bg-primary-50');
                        document.getElementById('desktopTimer').classList.add('timer-warning', 'text-danger-600');
                    }
                } else {
                    const timeText = formatTime(elapsed);
                    document.getElementById('mobileTimer').textContent = timeText;
                    document.getElementById('desktopTimer').textContent = timeText;
                }
            };

            updateDisplay();
            timerInterval = setInterval(updateDisplay, 1000);
        }

        // Force submit when time expires
        async function forceSubmit() {
            isForceSubmit = true;
            await alertDialog('Đã hết thời gian làm bài! Bài làm của bạn sẽ được nộp tự động.');
            doSubmit();
        }

        // Format time
        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return `${pad(h)}:${pad(m)}:${pad(s)}`;
        }

        function formatTimeText(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            
            let result = '';
            if (h > 0) result += `${h} giờ `;
            if (m > 0) result += `${m} phút `;
            result += `${s} giây`;
            return result;
        }

        function pad(num) {
            return num.toString().padStart(2, '0');
        }

        // Render mobile question nav (cells only, no expand button here)
        function renderMobileQuestionNav() {
            const nav = document.getElementById('mobileQuestionNav');
            nav.innerHTML = '';

            questions.forEach((q, index) => {
                const cell = document.createElement('button');
                cell.className = 'flex-shrink-0 w-9 h-9 flex items-center justify-center rounded-lg text-sm font-semibold transition-all bg-primary-50 text-primary-700 hover:bg-primary-100';
                cell.textContent = index + 1;
                cell.dataset.index = index;
                cell.id = `mobile-cell-${index}`;
                cell.addEventListener('click', () => scrollToQuestion(index));
                nav.appendChild(cell);
            });
            
            updateMobileNavScroll(0);
        }

        // Update mobile nav scroll position to keep current question centered
        function updateMobileNavScroll(index) {
            const nav = document.getElementById('mobileQuestionNav');
            const cell = document.getElementById(`mobile-cell-${index}`);
            if (!cell || !nav) return;

            // Update active state
            nav.querySelectorAll('button').forEach((btn, i) => {
                btn.classList.remove('bg-primary-600', 'bg-primary-100', 'text-white', 'ring-2', 'ring-primary-400', 'ring-success-500', 'bg-success-100', 'text-success-600');
                
                const answered = isQuestionAnswered(i);
                
                if (i === index) {
                    if (answered) {
                        btn.classList.add('bg-success-100', 'text-success-600', 'ring-2', 'ring-primary-400');
                    } else {
                        btn.classList.add('bg-primary-100', 'text-primary-700', 'ring-2', 'ring-primary-400');
                    }
                    btn.classList.remove('bg-primary-50');
                } else {
                    if (answered) {
                        btn.classList.add('bg-success-100', 'text-success-600');
                    } else {
                        btn.classList.add('bg-primary-50', 'text-primary-700');
                    }
                }
            });

            // Scroll to center the current cell
            const navRect = nav.getBoundingClientRect();
            const cellRect = cell.getBoundingClientRect();
            const scrollLeft = cell.offsetLeft - (navRect.width / 2) + (cellRect.width / 2);
            nav.scrollTo({ left: scrollLeft, behavior: 'smooth' });
        }

        // Render desktop question grid
        function renderDesktopQuestionGrid() {
            const grid = document.getElementById('desktopQuestionGrid');
            grid.innerHTML = '';

            questions.forEach((q, index) => {
                const cell = document.createElement('button');
                cell.className = 'aspect-square flex items-center justify-center rounded-lg text-sm font-semibold transition-all bg-primary-50 text-primary-700 hover:bg-primary-100';
                cell.textContent = index + 1;
                cell.dataset.index = index;
                cell.id = `desktop-cell-${index}`;
                cell.addEventListener('click', () => scrollToQuestion(index));
                grid.appendChild(cell);
            });
        }

        // Check if question is answered
        function isQuestionAnswered(index) {
            const ans = userAnswers[index];
            if (ans === undefined || ans === null) return false;
            if (typeof ans === 'object') {
                return Object.keys(ans).length > 0;
            }
            return true;
        }

        // Update question grid cell state
        function updateQuestionGrid(qIndex) {
            const mobileCell = document.getElementById(`mobile-cell-${qIndex}`);
            const desktopCell = document.getElementById(`desktop-cell-${qIndex}`);
            const expandCell = document.getElementById(`expand-cell-${qIndex}`);
            
            const answered = isQuestionAnswered(qIndex);
            
            [mobileCell, desktopCell, expandCell].forEach(cell => {
                if (!cell) return;
                if (answered) {
                    cell.classList.add('bg-success-100', 'text-success-600');
                    cell.classList.remove('bg-primary-50', 'text-primary-700');
                }
            });

            // Save progress when answer changes
            saveProgress();
        }

        // Get media URL from filename
        function getMediaUrl(media) {
            if (!media) return null;
            if (typeof media === 'string') {
                return mediaFiles[media] || null;
            }
            if (Array.isArray(media) && media.length > 0) {
                return media.map(m => mediaFiles[m]).filter(Boolean);
            }
            return null;
        }

        // Detect media type
        function getMediaType(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const imageExts = ['png', 'jpg', 'jpeg', 'gif', 'svg', 'webp', 'bmp'];
            const audioExts = ['mp3', 'wav', 'ogg', 'm4a', 'aac', 'flac'];
            const videoExts = ['mp4', 'webm', 'ogg', 'mov', 'avi'];
            
            if (imageExts.includes(ext)) return 'image';
            if (audioExts.includes(ext)) return 'audio';
            if (videoExts.includes(ext)) return 'video';
            return 'unknown';
        }

        // Render media
        function renderMedia(media) {
            if (!media) return '';
            
            const urls = Array.isArray(media) ? media : [media];
            let html = '<div class="mt-3 space-y-2">';
            
            urls.forEach(filename => {
                const url = mediaFiles[filename];
                if (!url) return;
                
                const type = getMediaType(filename);
                if (type === 'image') {
                    html += `<img src="${url}" alt="Media" class="max-w-full max-h-80 rounded-lg shadow-sm">`;
                } else if (type === 'audio') {
                    html += `<audio controls src="${url}" class="w-full media-player"></audio>`;
                } else if (type === 'video') {
                    html += `<video controls src="${url}" class="w-full rounded-lg media-player"></video>`;
                }
            });
            
            html += '</div>';
            return html;
        }

        // Setup media player controls
        function setupMediaPlayers() {
            document.querySelectorAll('.media-player').forEach(media => {
                media.addEventListener('play', function() {
                    if (currentPlayingMedia && currentPlayingMedia !== this) {
                        currentPlayingMedia.pause();
                    }
                    currentPlayingMedia = this;
                });
            });
        }

        // Stop all media
        function stopAllMedia() {
            document.querySelectorAll('.media-player').forEach(media => {
                media.pause();
                media.currentTime = 0;
            });
            currentPlayingMedia = null;
        }

        // Render questions
        function renderQuestions() {
            const container = document.getElementById('questionContainer');
            container.innerHTML = '';

            let prevType = null;
            questions.forEach((q, index) => {
                // Section header when type changes
                if (q.type !== prevType) {
                    const header = document.createElement('div');
                    header.className = 'text-lg font-bold text-white/90 mt-6 mb-3';
                    if (q.type === 'multiple_choice') header.textContent = 'Trắc nghiệm (ABCD)';
                    else if (q.type === 'true_false_group') header.textContent = 'Trắc nghiệm (Đúng / Sai)';
                    container.appendChild(header);
                    prevType = q.type;
                }

                const qDiv = document.createElement('div');
                qDiv.className = 'bg-white rounded-xl p-5 sm:p-6 shadow-lg';
                qDiv.dataset.index = index;
                qDiv.id = `question-${index}`;

                let html = `<div class="inline-block bg-primary-600 text-white px-3 py-1 rounded-full text-sm font-semibold mb-4">Câu ${index + 1}</div>`;

                html += '<div class="text-base sm:text-lg leading-relaxed text-primary-900 mb-5">';
                if (q.question && q.question.text) {
                    html += marked.parse(q.question.text);
                }
                if (q.question && q.question.media) {
                    html += renderMedia(q.question.media);
                }
                html += '</div>';

                if (q.type === 'multiple_choice') {
                    html += renderMultipleChoice(q, index);
                } else if (q.type === 'true_false_group') {
                    html += renderTrueFalseGroup(q, index);
                }

                qDiv.innerHTML = html;
                container.appendChild(qDiv);
            });

            setupEventListeners();
            setupMediaPlayers();

            // Restore answered state visuals
            Object.keys(userAnswers).forEach(idx => {
                const qIndex = parseInt(idx);
                if (isQuestionAnswered(qIndex)) {
                    updateQuestionGrid(qIndex);
                    
                    // Restore radio/checkbox states
                    const q = questions[qIndex];
                    if (q.type === 'multiple_choice') {
                        const radio = document.querySelector(`input[name="q${qIndex}"][value="${userAnswers[qIndex]}"]`);
                        if (radio) radio.checked = true;
                    } else if (q.type === 'true_false_group') {
                        const answers = userAnswers[qIndex] || {};
                        Object.keys(answers).forEach(itemIdx => {
                            const val = answers[itemIdx];
                            const radio = document.querySelector(`input[name="q${qIndex}_item${itemIdx}"][value="${val}"]`);
                            if (radio) radio.checked = true;
                        });
                    }
                }
            });
        }

        // Render multiple choice question
        function renderMultipleChoice(q, qIndex) {
            let html = '<div class="space-y-2">';
            q.shuffledChoices.forEach((choice, choiceIndex) => {
                const choiceId = `q${qIndex}_c${choiceIndex}`;
                html += `
                    <label for="${choiceId}" class="choice-item flex items-start gap-3 p-3 rounded-lg border-2 border-primary-100 cursor-pointer hover:border-primary-300 transition-colors">
                        <input type="radio" name="q${qIndex}" value="${choiceIndex}" id="${choiceId}" class="mt-1 w-4 h-4 text-primary-600" onchange="handleMCAnswer(${qIndex}, ${choiceIndex})">
                        <span class="font-semibold text-primary-600">${choiceIndex + 1}.</span>
                        <span class="flex-1 text-primary-800">${choice.text || ''}</span>
                `;
                if (choice.media) {
                    html += renderMedia(choice.media);
                }
                html += '</label>';
            });
            html += '</div>';
            return html;
        }

        // Render true/false group question
        function renderTrueFalseGroup(q, qIndex) {
            let html = '<div class="space-y-3">';
            q.shuffledItems.forEach((item, itemIndex) => {
                html += `
                    <div class="p-4 bg-primary-50 rounded-lg">
                        <div class="flex items-start gap-2 mb-3">
                            <span class="font-semibold text-primary-600">${itemIndex + 1}.</span>
                            <span class="text-primary-800">${item.text || ''}</span>
                `;
                if (item.media) {
                    html += renderMedia(item.media);
                }
                html += `
                        </div>
                        <div class="flex gap-4 ml-5">
                            <label class="tf-btn flex items-center gap-2 px-4 py-2 rounded-lg border-2 border-primary-200 cursor-pointer hover:border-primary-400 transition-colors">
                                <input type="radio" name="q${qIndex}_item${itemIndex}" value="true" class="w-4 h-4 text-primary-600" onchange="handleTFAnswer(${qIndex}, ${itemIndex}, true)">
                                <span class="font-medium">Đúng</span>
                            </label>
                            <label class="tf-btn flex items-center gap-2 px-4 py-2 rounded-lg border-2 border-primary-200 cursor-pointer hover:border-primary-400 transition-colors">
                                <input type="radio" name="q${qIndex}_item${itemIndex}" value="false" class="w-4 h-4 text-primary-600" onchange="handleTFAnswer(${qIndex}, ${itemIndex}, false)">
                                <span class="font-medium">Sai</span>
                            </label>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }

        // Handle multiple choice answer
        function handleMCAnswer(qIndex, choiceIndex) {
            userAnswers[qIndex] = choiceIndex;
            updateQuestionGrid(qIndex);
        }

        // Handle true/false answer
        function handleTFAnswer(qIndex, itemIndex, value) {
            if (!userAnswers[qIndex]) {
                userAnswers[qIndex] = {};
            }
            userAnswers[qIndex][itemIndex] = value;
            
            // Check if all items answered
            const q = questions[qIndex];
            const allAnswered = q.shuffledItems.every((_, i) => 
                userAnswers[qIndex][i] !== undefined
            );
            if (allAnswered) {
                updateQuestionGrid(qIndex);
            } else {
                saveProgress();
            }
        }

        // Update desktop question grid scroll position to keep current question visible
        function updateDesktopGridScroll(index) {
            const container = document.getElementById('desktopQuestionGridContainer');
            const cell = document.getElementById(`desktop-cell-${index}`);
            if (!cell || !container) return;

            // Scroll to make the current cell visible (centered if possible)
            cell.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Intersection observer for question tracking
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const index = parseInt(entry.target.dataset.index);
                        currentQuestionIndex = index;
                        
                        // Update desktop grid active state
                        document.querySelectorAll('#desktopQuestionGrid button').forEach((cell, i) => {
                            cell.classList.remove('ring-2', 'ring-primary-500');
                            if (i === index) {
                                cell.classList.add('ring-2', 'ring-primary-500');
                            }
                        });
                        
                        // Auto-scroll desktop question grid to current question
                        updateDesktopGridScroll(index);
                        
                        // Update mobile nav
                        updateMobileNavScroll(index);

                        // Update expand grid if open
                        if (isMobileExpandOpen) {
                            updateMobileExpandGrid();
                        }

                        // Save current position
                        saveProgress();
                    }
                });
            }, { threshold: 0.5 });

            document.querySelectorAll('#questionContainer > div[data-index]').forEach(item => {
                observer.observe(item);
            });
        }

        // Scroll to question
        function scrollToQuestion(index) {
            const el = document.getElementById(`question-${index}`);
            if (el) {
                const topOffset = window.innerWidth < 1024 ? 100 : 20; // Account for mobile topbar
                const elementPosition = el.getBoundingClientRect().top + window.pageYOffset;
                window.scrollTo({ top: elementPosition - topOffset, behavior: 'smooth' });
            }
        }

        // Submit exam
        async function submitExam(force = false) {
            if (!force) {
                const confirmed = await confirmDialog('Bạn có chắc chắn muốn nộp bài? Nếu chưa sẵn sàng, có thể tiếp tục làm bài.');
                if (!confirmed) return;
            }
            doSubmit();
        }

        function doSubmit() {
            clearInterval(timerInterval);
            stopAllMedia();
            
            // Calculate actual duration
            actualDuration = Math.floor((Date.now() - startTime) / 1000);
            
            // Clear localStorage
            clearProgress();
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            document.getElementById('examScreen').classList.add('hidden');
            document.getElementById('resultsScreen').classList.remove('hidden');

            gradeExam();
            renderResultsSidebar();
            renderMobileResultsNav();
            setupResultsExpand();
        }

        // Setup results expand panel
        function setupResultsExpand() {
            const expandBtn = document.getElementById('mobileResultsExpandBtn');
            const overlay = document.getElementById('mobileResultsExpandOverlay');
            const closeBtn = document.getElementById('mobileResultsExpandClose');
            const backdrop = document.getElementById('mobileResultsExpandBackdrop');

            expandBtn.addEventListener('click', toggleMobileResultsExpand);
            closeBtn.addEventListener('click', closeMobileResultsExpand);
            backdrop.addEventListener('click', closeMobileResultsExpand);
        }

        function toggleMobileResultsExpand() {
            if (isMobileResultsExpandOpen) {
                closeMobileResultsExpand();
            } else {
                openMobileResultsExpand();
            }
        }

        function openMobileResultsExpand() {
            const overlay = document.getElementById('mobileResultsExpandOverlay');
            const panel = document.getElementById('mobileResultsExpandPanel');
            
            isMobileResultsExpandOpen = true;
            overlay.classList.remove('hidden');
            overlay.classList.add('flex', 'flex-col');
            panel.classList.add('expand-panel-enter');
            overlay.classList.add('expand-overlay-enter');
        }

        function closeMobileResultsExpand() {
            const overlay = document.getElementById('mobileResultsExpandOverlay');
            const panel = document.getElementById('mobileResultsExpandPanel');
            
            isMobileResultsExpandOpen = false;
            panel.classList.remove('expand-panel-enter');
            panel.classList.add('expand-panel-leave');
            overlay.classList.remove('expand-overlay-enter');
            overlay.classList.add('expand-overlay-leave');
            
            setTimeout(() => {
                overlay.classList.add('hidden');
                overlay.classList.remove('flex', 'flex-col', 'expand-overlay-leave');
                panel.classList.remove('expand-panel-leave');
            }, 300);
        }

        // Render results sidebar (desktop)
        function renderResultsSidebar() {
            const grid = document.getElementById('resultsQuestionGrid');
            const expandGrid = document.getElementById('mobileResultsExpandGrid');
            grid.innerHTML = '';
            expandGrid.innerHTML = '';

            questions.forEach((q, index) => {
                const isCorrect = questionResults[index];
                
                // Desktop sidebar cell
                const cell = document.createElement('button');
                cell.className = `aspect-square flex items-center justify-center rounded-lg text-sm font-semibold transition-all ${isCorrect ? 'bg-success-100 text-success-600 hover:bg-success-200' : 'bg-danger-100 text-danger-600 hover:bg-danger-200'}`;
                cell.textContent = index + 1;
                cell.addEventListener('click', () => scrollToResult(index));
                grid.appendChild(cell);

                // Mobile expand grid cell
                const expandCell = document.createElement('button');
                expandCell.className = `w-9 h-9 flex items-center justify-center rounded-lg text-sm font-semibold transition-all ${isCorrect ? 'bg-success-100 text-success-600 hover:bg-success-200' : 'bg-danger-100 text-danger-600 hover:bg-danger-200'}`;
                expandCell.textContent = index + 1;
                expandCell.addEventListener('click', () => {
                    scrollToResult(index);
                    closeMobileResultsExpand();
                });
                expandGrid.appendChild(expandCell);
            });

            // Sidebar buttons
            document.getElementById('sidebarReviewBtn').addEventListener('click', () => location.reload());
        }

        // Render mobile results nav (only wrong answers)
        function renderMobileResultsNav() {
            const nav = document.getElementById('mobileResultsNav');
            nav.innerHTML = '';

            const wrongIndices = [];
            questions.forEach((q, index) => {
                if (!questionResults[index]) {
                    wrongIndices.push(index);
                }
            });

            if (wrongIndices.length === 0) {
                const msg = document.createElement('span');
                msg.className = 'text-sm text-success-600 font-medium';
                msg.textContent = '🎉 Không có câu sai nào!';
                nav.appendChild(msg);
            } else {
                wrongIndices.forEach(index => {
                    const cell = document.createElement('button');
                    cell.className = 'flex-shrink-0 w-9 h-9 flex items-center justify-center rounded-lg text-sm font-semibold transition-all bg-danger-100 text-danger-600 hover:bg-danger-200';
                    cell.textContent = index + 1;
                    cell.addEventListener('click', () => scrollToResult(index));
                    nav.appendChild(cell);
                });
            }
        }

        // Scroll to result
        function scrollToResult(index) {
            const el = document.getElementById(`result-${index}`);
            if (el) {
                const topOffset = window.innerWidth < 1024 ? 100 : 20;
                const elementPosition = el.getBoundingClientRect().top + window.pageYOffset;
                window.scrollTo({ top: elementPosition - topOffset, behavior: 'smooth' });
            }
        }

        // Grade exam
        function gradeExam() {
            let correctCount = 0;
            let totalCount = questions.length;
            questionResults = [];

            questions.forEach((q, index) => {
                let isCorrect = false;
                
                if (q.type === 'multiple_choice') {
                    const userAnswer = userAnswers[index];
                    if (userAnswer !== undefined) {
                        const correctIndex = q.shuffledChoices.findIndex(
                            c => c.originalKey === q.correct
                        );
                        if (userAnswer === correctIndex) {
                            isCorrect = true;
                            correctCount++;
                        }
                    }
                } else if (q.type === 'true_false_group') {
                    const userAnswer = userAnswers[index] || {};
                    
                    const allAnswered = q.shuffledItems.every((item, i) => 
                        userAnswer[i] !== undefined
                    );
                    
                    if (allAnswered) {
                        let allCorrect = true;
                        q.shuffledItems.forEach((item, i) => {
                            if (userAnswer[i] !== item.correct) {
                                allCorrect = false;
                            }
                        });
                        
                        if (allCorrect) {
                            isCorrect = true;
                            correctCount++;
                        }
                    }
                }
                
                questionResults.push(isCorrect);
            });

            // Display score
            const percent = Math.round(correctCount / totalCount * 100);
            const duration = configData.exam.duration_minutes || 0;
            const scoreSummary = document.getElementById('scoreSummary');
            
            let summaryHTML = `
                <div class="bg-gradient-to-br from-primary-600 to-primary-800 text-white p-6 rounded-xl text-center">
                    <div class="text-sm opacity-90 mb-2">Điểm số</div>
                    <div class="text-5xl font-bold mb-1">${percent}%</div>
                    <div class="text-lg opacity-90">${correctCount}/${totalCount} câu đúng</div>
                </div>
                <div class="bg-primary-50 p-6 rounded-xl">
                    <div class="text-sm text-primary-600 mb-2">Thống kê</div>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-primary-700">Đúng</span>
                            <span class="font-semibold text-success-600">${correctCount}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-primary-700">Sai</span>
                            <span class="font-semibold text-danger-600">${totalCount - correctCount}</span>
                        </div>
            `;
            
            // Show actual time for unlimited duration exams
            if (duration === 0) {
                summaryHTML += `
                        <div class="flex justify-between pt-2 border-t border-primary-200 mt-2">
                            <span class="text-primary-700">Thời gian làm bài</span>
                            <span class="font-semibold text-primary-900">${formatTimeText(actualDuration)}</span>
                        </div>
                `;
            }
            
            summaryHTML += `
                    </div>
                </div>
            `;
            
            scoreSummary.innerHTML = summaryHTML;

            displayResults();
        }

        // Display results
        function displayResults() {
            const container = document.getElementById('resultsDetailsContainer');
            container.innerHTML = '';

            questions.forEach((q, index) => {
                const isCorrect = questionResults[index];
                const resultDiv = document.createElement('div');
                resultDiv.className = `bg-primary-50 p-5 rounded-xl border-l-4 ${isCorrect ? 'border-success-500' : 'border-danger-500'}`;
                resultDiv.id = `result-${index}`;

                let html = `<h3 class="font-bold text-lg text-primary-900 mb-3">Câu ${index + 1}</h3>`;
                html += '<div class="text-primary-800 mb-4">';
                if (q.question && q.question.text) {
                    html += marked.parse(q.question.text);
                }
                if (q.question && q.question.media) {
                    html += renderMedia(q.question.media);
                }
                html += '</div>';

                if (q.type === 'multiple_choice') {
                    html += displayMultipleChoiceResult(q, index);
                } else if (q.type === 'true_false_group') {
                    html += displayTrueFalseResult(q, index);
                }

                resultDiv.innerHTML = html;
                container.appendChild(resultDiv);
            });

            document.getElementById('reviewBtn').addEventListener('click', () => {
                location.reload();
            });
            
            setupMediaPlayers();
        }

        // Display multiple choice result
        function displayMultipleChoiceResult(q, index) {
            const userAnswer = userAnswers[index];
            const correctIndex = q.shuffledChoices.findIndex(c => c.originalKey === q.correct);
            const isCorrect = userAnswer === correctIndex;

            let html = `<div class="inline-block px-4 py-1.5 rounded-full text-sm font-semibold mb-4 ${isCorrect ? 'bg-success-100 text-success-600' : 'bg-danger-100 text-danger-600'}">`;
            html += isCorrect ? '✓ Đúng' : '✗ Sai';
            html += '</div>';

            html += '<div class="space-y-2">';
            q.shuffledChoices.forEach((choice, i) => {
                const isUserAnswer = i === userAnswer;
                const isCorrectAnswer = i === correctIndex;
                let bgClass = 'bg-white border-primary-100';
                if (isCorrectAnswer) bgClass = 'bg-success-50 border-success-300';
                if (isUserAnswer && !isCorrect) bgClass = 'bg-danger-50 border-danger-300';

                html += `<div class="flex items-start gap-3 p-3 rounded-lg border-2 ${bgClass}">`;
                html += `<span class="font-semibold text-primary-600">${i + 1}.</span>`;
                html += `<span class="flex-1 text-primary-800">${choice.text || ''}</span>`;
                if (choice.media) {
                    html += renderMedia(choice.media);
                }
                if (isCorrectAnswer) html += '<span class="text-xs bg-success-100 text-success-600 px-2 py-0.5 rounded-full">Đáp án đúng</span>';
                if (isUserAnswer) html += '<span class="text-xs bg-primary-100 text-primary-600 px-2 py-0.5 rounded-full ml-1">Bạn chọn</span>';
                html += '</div>';
            });
            html += '</div>';

            return html;
        }

        // Display true/false result
        function displayTrueFalseResult(q, index) {
            const userAnswer = userAnswers[index] || {};
            
            const allAnswered = q.shuffledItems.every((item, i) => 
                userAnswer[i] !== undefined
            );
            
            let allCorrect = false;
            if (allAnswered) {
                allCorrect = true;
                q.shuffledItems.forEach((item, i) => {
                    if (userAnswer[i] !== item.correct) {
                        allCorrect = false;
                    }
                });
            }

            let html = `<div class="inline-block px-4 py-1.5 rounded-full text-sm font-semibold mb-4 ${allCorrect ? 'bg-success-100 text-success-600' : 'bg-danger-100 text-danger-600'}">`;
            html += allCorrect ? '✓ Đúng' : '✗ Sai';
            html += '</div>';

            html += '<div class="space-y-2">';
            q.shuffledItems.forEach((item, i) => {
                const userVal = userAnswer[i];
                const isCorrect = userVal === item.correct;
                const bgClass = isCorrect ? 'bg-success-50 border-success-300' : 'bg-danger-50 border-danger-300';
                
                html += `<div class="p-3 rounded-lg border-2 ${bgClass}">`;
                html += `<div class="flex items-start gap-2 mb-2">`;
                html += `<span class="font-semibold text-primary-600">${i + 1}.</span>`;
                html += `<span class="text-primary-800">${item.text || ''}</span>`;
                if (item.media) {
                    html += renderMedia(item.media);
                }
                html += `</div>`;
                html += `<div class="flex gap-4 text-sm">`;
                html += `<span>Bạn: <strong class="${userVal === item.correct ? 'text-success-600' : 'text-danger-600'}">${userVal === true ? 'Đúng' : userVal === false ? 'Sai' : 'Chưa trả lời'}</strong></span>`;
                html += `<span>Đáp án: <strong class="text-primary-700">${item.correct ? 'Đúng' : 'Sai'}</strong></span>`;
                html += `</div>`;
                html += `</div>`;
            });
            html += '</div>';

            return html;
        }

        // Utility functions
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function shuffleChoices(question) {
            const entries = Object.entries(question.choices || {});
            const shuffled = entries.map(([key, value]) => ({
                ...value,
                originalKey: key
            }));
            shuffleArray(shuffled);
            question.shuffledChoices = shuffled;
        }

        function shuffleItems(question) {
            const entries = Object.entries(question.items || {});
            const shuffled = entries.map(([key, value]) => ({
                ...value,
                originalKey: key
            }));
            shuffleArray(shuffled);
            question.shuffledItems = shuffled;
        }

        function shuffleChoicesKeepOrder(question) {
            const entries = Object.entries(question.choices || {});
            const list = entries.map(([key, value]) => ({
                ...value,
                originalKey: key
            }));
            question.shuffledChoices = list;
        }

        function shuffleItemsKeepOrder(question) {
            const entries = Object.entries(question.items || {});
            const list = entries.map(([key, value]) => ({
                ...value,
                originalKey: key
            }));
            question.shuffledItems = list;
        }

        // Show error screen
        function showError() {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('errorScreen').classList.remove('hidden');
            document.getElementById('errorScreen').classList.add('flex');
        }

        // Show time expired screen
        function showTimeExpired(message) {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('timeExpiredScreen').classList.remove('hidden');
            document.getElementById('timeExpiredScreen').classList.add('flex');
            document.getElementById('timeExpiredInfo').textContent = message;
        }
    </script>
</body>
</html>
